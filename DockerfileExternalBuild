FROM openjdk:jre-alpine
WORKDIR /code/
ARG PROPERTIES_PATH_CORE=core/src/main/resources/application.properties
RUN echo PROPERTIES_PATH_CORE
COPY $PROPERTIES_PATH_CORE /etc/zoom/application.properties
ARG LOGBACK_PATH=core/src/main/resources/logback.xml
RUN echo $LOGBACK_PATH
COPY $LOGBACK_PATH /code/logback.xml
ARG SPRING_PROFILE=staging
RUN echo $SPRING_PROFILE
ARG XMX_XMS_VALUE=512m
RUN echo $XMX_XMS_VALUE
ENV COMMON_JAVA_OPTS="-Xms$XMX_XMS_VALUE -Xmx$XMX_XMS_VALUE -Dlogin.profiles.active=$LOGIN_PROFILE"
RUN echo $COMMON_JAVA_OPTS

RUN mkdir -p /etc/zoom/event
WORKDIR /code/
COPY eventConsumer/build/distributions/eventConsumer.zip /code/
RUN unzip /code/eventConsumer.zip
ARG PROPERTIES_PATH_EVENT=eventConsumer/src/main/resources/application.properties
RUN echo PROPERTIES_PATH_EVENT
COPY $PROPERTIES_PATH_EVENT /etc/zoom/application_event.properties
ENV JAVA_OPTS=$COMMON_JAVA_OPTS" -Dspring.config.location=/etc/zoom/application.properties,/etc/zoom/application_event.properties"
RUN echo $JAVA_OPTS
WORKDIR /code/eventConsumer/bin
RUN sed -i 's%DEFAULT_JVM_OPTS=""%DEFAULT_JVM_OPTS=$JAVA_OPTS%g' eventConsumer
ENTRYPOINT exec ./eventConsumer

RUN mkdir -p /etc/zoom/notification
WORKDIR /code/
COPY notificationConsumer/build/distributions/notificationConsumer.zip /code/
RUN unzip /code/notificationConsumer.zip
ARG PROPERTIES_PATH_NOTIFICATION=notificationConsumer/src/main/resources/application.properties
RUN echo PROPERTIES_PATH_NOTIFICATION
COPY $PROPERTIES_PATH_NOTIFICATION /etc/zoom/application_notification.properties
ENV JAVA_OPTS=$COMMON_JAVA_OPTS" -Dspring.config.location=/etc/zoom/application.properties,/etc/zoom/application_notification.properties"
RUN echo $JAVA_OPTS
WORKDIR /code/notificationConsumer/bin
RUN sed -i 's%DEFAULT_JVM_OPTS=""%DEFAULT_JVM_OPTS=$JAVA_OPTS%g' notificationConsumer
ENTRYPOINT exec ./notificationConsumer