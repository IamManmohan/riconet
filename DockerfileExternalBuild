FROM rivigotech/openjdk-supervisor:8-jre-alpine
WORKDIR /code/
ARG PROPERTIES_PATH_CORE=core/src/main/resources/application_core.properties
RUN echo $PROPERTIES_PATH_CORE
COPY $PROPERTIES_PATH_CORE /etc/zoom/application.properties
ARG SPRING_PROFILE=local_docker
RUN echo $SPRING_PROFILE
ARG LOGIN_PROFILE=staging
RUN echo $LOGIN_PROFILE
ARG XMX_XMS_VALUE=512m
RUN echo $XMX_XMS_VALUE
ENV COMMON_JAVA_OPTS="-Xms$XMX_XMS_VALUE -Xmx$XMX_XMS_VALUE -Dlogin.profiles.active=$LOGIN_PROFILE -Dspring.profiles.active=$SPRING_PROFILE"
RUN echo $COMMON_JAVA_OPTS

WORKDIR /code/
COPY eventConsumer/build/distributions/eventConsumer.zip /code/
RUN unzip /code/eventConsumer.zip
RUN rm /code/eventConsumer.zip
ARG PROPERTIES_PATH_EVENT=eventConsumer/src/main/resources/application_event.properties
RUN echo $PROPERTIES_PATH_EVENT
COPY $PROPERTIES_PATH_EVENT /etc/zoom/application_event.properties
ENV EVENT_JAVA_OPTS=$COMMON_JAVA_OPTS" -Dspring.config.location=/etc/zoom/application.properties,/etc/zoom/application_event.properties"
RUN echo $EVENT_JAVA_OPTS
WORKDIR /code/eventConsumer/bin
RUN sed -i "s%DEFAULT_JVM_OPTS=\"\"%DEFAULT_JVM_OPTS=\"$EVENT_JAVA_OPTS\"%g" eventConsumer

WORKDIR /code/
COPY notificationConsumer/build/distributions/notificationConsumer.zip /code/
RUN unzip /code/notificationConsumer.zip
RUN rm /code/notificationConsumer.zip
ARG PROPERTIES_PATH_NOTIFICATION=notificationConsumer/src/main/resources/application_notification.properties
RUN echo $PROPERTIES_PATH_NOTIFICATION
COPY $PROPERTIES_PATH_NOTIFICATION /etc/zoom/application_notification.properties
ENV NOTIFICATION_JAVA_OPTS=$COMMON_JAVA_OPTS" -Dspring.config.location=/etc/zoom/application.properties,/etc/zoom/application_notification.properties"
RUN echo $NOTIFICATION_JAVA_OPTS
WORKDIR /code/notificationConsumer/bin
RUN sed -i "s%DEFAULT_JVM_OPTS=\"\"%DEFAULT_JVM_OPTS=\"$NOTIFICATION_JAVA_OPTS\"%g" notificationConsumer

WORKDIR /code/
COPY supervisord.conf /etc/supervisord.conf
ENTRYPOINT exec /usr/bin/supervisord